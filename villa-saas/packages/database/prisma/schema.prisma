generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==================== MULTI-TENANCY ====================

model Tenant {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Informations du propriétaire
  name        String
  email       String   @unique
  phone       String?
  companyName String?
  siret       String?
  vatNumber   String?

  // Configuration
  subdomain     String?  @unique
  customDomain  String?  @unique
  isActive      Boolean  @default(true)
  settings      Json     @default("{}")

  // Stripe Connect
  stripeAccountId         String?
  stripeAccountStatus     String?
  stripeDetailsSubmitted  Boolean @default(false)
  stripeChargesEnabled    Boolean @default(false)
  stripePayoutsEnabled    Boolean @default(false)

  // Relations
  users         User[]
  properties    Property[]
  bookings      Booking[]
  periods       Period[]
  tourists      TouristTax[]
  emails        EmailTemplate[]
  integrations  Integration[]
  auditLogs     AuditLog[]
  publicSite    PublicSite?
  promoCodes    PromoCode[]

  @@index([email])
  @@index([subdomain])
  @@index([customDomain])
}

// ==================== SITES PUBLICS ====================

model PublicSite {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  tenantId String @unique
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  // Configuration domaine
  domain        String?  @unique
  subdomain     String?  @unique
  isActive      Boolean  @default(false)
  
  // Personnalisation
  theme         Json?    // Couleurs, fonts, etc.
  logo          String?
  favicon       String?
  metadata      Json?    // SEO, analytics
  
  // Localisation
  defaultLocale String   @default("fr")
  locales       Json     @default("[\"fr\"]")
  
  // Analytics
  googleAnalyticsId String?
  facebookPixelId   String?
  
  @@index([domain])
  @@index([subdomain])
  @@index([tenantId])
}

// ==================== UTILISATEURS ====================

model User {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  email          String  @unique
  passwordHash   String
  firstName      String
  lastName       String
  phone          String?
  isActive       Boolean @default(true)
  emailVerified  Boolean @default(false)

  // Multi-tenancy
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  // Rôle et permissions
  role        UserRole @default(USER)
  permissions Json     @default("[]")

  // Tokens
  refreshTokens RefreshToken[]
  sessions      Session[]

  // Relations
  bookings       Booking[]
  auditLogs      AuditLog[]
  mobileSessions MobileSession[]
  loyaltyProgram LoyaltyProgram?

  @@unique([email, tenantId])
  @@index([tenantId])
  @@index([email])
}

enum UserRole {
  OWNER
  ADMIN
  USER
}

model RefreshToken {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  expiresAt DateTime
  token     String   @unique
  
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId])
  @@index([token])
}

model Session {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  expiresAt DateTime
  token     String   @unique
  userAgent String?
  ip        String?
  
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId])
  @@index([token])
}

// ==================== PROPRIÉTÉS ====================

model Property {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Multi-tenancy
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  // Informations de base
  name         String
  slug         String
  propertyType PropertyType
  status       PropertyStatus @default(DRAFT)

  // Localisation
  address      String
  city         String
  postalCode   String
  country      String  @default("FR")
  latitude     Float?
  longitude    Float?

  // Capacité
  bedrooms    Int
  bathrooms   Int
  maxGuests   Int
  surfaceArea Float? // en m²

  // Description multilingue
  description Json // { fr: "", en: "", es: "", ... }

  // Tarifs de base
  basePrice        Float
  weekendPremium   Float?  @default(0)
  cleaningFee      Float?
  securityDeposit  Float?

  // Règles
  minNights        Int     @default(1)
  checkInTime      String  @default("16:00")
  checkOutTime     String  @default("11:00")
  checkInDays      Json    @default("[1,2,3,4,5,6,0]") // Jours autorisés
  instantBooking   Boolean @default(false)

  // Équipements et caractéristiques (pour l'IA)
  amenities         Json    @default("{}") // { wifi: true, pool: true, ... }
  atmosphere        Json    @default("{}") // { romantic: 0.8, family: 0.9, ... }
  proximity         Json    @default("{}") // { beach: 500, shops: 200, ... }
  
  // Recherche IA
  searchableContent String? @db.Text
  embedding         Float[] @default([]) // Vector pour similarité sémantique

  // Médias
  images           PropertyImage[]
  
  // Relations
  bookings         Booking[]
  blockedPeriods   BlockedPeriod[]
  periods          Period[]
  reviews          Review[]
  mlPredictions    MLPrediction[]
  propertyEmbedding PropertyEmbedding?
  smartDevices     SmartDevice[]
  analytics        PropertyAnalytics[]
  
  @@unique([tenantId, slug])
  @@index([tenantId])
  @@index([status])
  @@index([slug])
}

enum PropertyType {
  APARTMENT
  HOUSE
  VILLA
  STUDIO
  LOFT
  CHALET
  BUNGALOW
  MOBILE_HOME
  BOAT
  OTHER
}

enum PropertyStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
}

model PropertyImage {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  
  propertyId String
  property   Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  
  url         String      // URL de base ou originale
  urls        Json?       // URLs des différentes tailles {small, medium, large, original}
  alt         String?
  caption     Json?       // Multilingue
  order       Int
  isPrimary   Boolean  @default(false)
  
  @@unique([propertyId, order])
  @@index([propertyId])
}

// ==================== TARIFICATION ====================

model Period {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Multi-tenancy
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  propertyId String?
  property   Property? @relation(fields: [propertyId], references: [id], onDelete: Cascade)

  name       String
  startDate  DateTime
  endDate    DateTime
  priority   Int      @default(0) // Plus élevé = plus prioritaire

  // Tarifs
  basePrice         Float
  weekendPremium    Float?
  minNights         Int?
  checkInDays       Json?   // Override les jours de check-in

  // Application
  isGlobal   Boolean @default(false) // S'applique à toutes les propriétés du tenant
  isActive   Boolean @default(true)

  @@index([tenantId])
  @@index([propertyId])
  @@index([startDate, endDate])
  @@index([priority])
}

// ==================== RÉSERVATIONS ====================

model Booking {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Multi-tenancy
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  propertyId String
  property   Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)

  userId String?
  user   User?   @relation(fields: [userId], references: [id], onDelete: SetNull)

  // Référence unique
  reference String @unique @default(cuid())

  // Dates
  checkIn  DateTime
  checkOut DateTime
  nights   Int

  // Invités
  adults   Int
  children Int      @default(0)
  infants  Int      @default(0)
  pets     Int      @default(0)

  // Informations client
  guestFirstName String
  guestLastName  String
  guestEmail     String
  guestPhone     String
  guestCountry   String?
  guestAddress   String?
  guestNotes     String? @db.Text

  // Statut
  status BookingStatus

  // Montants
  accommodationTotal Float
  cleaningFee        Float @default(0)
  touristTax         Float @default(0)
  extraFees          Json  @default("[]") // Frais additionnels
  discountAmount     Float @default(0)
  discountCode       String?
  promoCodeId        String?
  promoCode          PromoCode? @relation(fields: [promoCodeId], references: [id], onDelete: SetNull)
  subtotal           Float
  total              Float
  currency           String @default("EUR")

  // Paiement
  paymentStatus   PaymentStatus @default(PENDING)
  stripePaymentId String?
  depositAmount   Float         @default(0)
  depositPaid     Boolean       @default(false)
  
  // Commission
  commissionRate   Float   @default(0.15) // 15%
  commissionAmount Float
  payoutAmount     Float
  payoutStatus     PayoutStatus @default(PENDING)
  stripeTransferId String?

  // Annulation
  cancellationDate      DateTime?
  cancellationReason    String?
  refundAmount          Float?
  stripeRefundId        String?

  // Métadonnées
  source           String? // website, airbnb, booking, etc.
  externalId       String? // ID de réservation externe
  specialRequests  String? @db.Text
  internalNotes    String? @db.Text

  // Relations
  payments              Payment[]
  reviews               Review[]
  blockchainTransactions BlockchainTransaction[]
  
  @@index([tenantId])
  @@index([propertyId])
  @@index([userId])
  @@index([reference])
  @@index([status])
  @@index([checkIn, checkOut])
  @@index([guestEmail])
}

enum BookingStatus {
  PENDING
  CONFIRMED
  CANCELLED
  COMPLETED
  NO_SHOW
}

enum PaymentStatus {
  PENDING
  PAID
  PARTIALLY_PAID
  FAILED
  REFUNDED
  PARTIALLY_REFUNDED
}

enum PayoutStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}

// ==================== PAIEMENTS ====================

model Payment {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())

  bookingId String
  booking   Booking @relation(fields: [bookingId], references: [id], onDelete: Cascade)

  amount          Float
  currency        String
  type            PaymentType
  status          PaymentStatus
  stripePaymentId String?
  metadata        Json?

  @@index([bookingId])
  @@index([stripePaymentId])
}

enum PaymentType {
  BOOKING
  DEPOSIT
  REFUND
  EXTRA
}

// ==================== PÉRIODES BLOQUÉES ====================

model BlockedPeriod {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())

  propertyId String
  property   Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)

  startDate DateTime
  endDate   DateTime
  reason    String?
  notes     String?

  @@index([propertyId])
  @@index([startDate, endDate])
}

// ==================== TAXES DE SÉJOUR ====================

model TouristTax {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Multi-tenancy
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  name        String
  enabled     Boolean @default(true)
  
  // Configuration du calcul
  calculationType TaxCalculationType
  amount          Float?             // Montant fixe par personne par nuit
  percentage      Float?             // Pourcentage du prix
  maxAmount       Float?             // Plafond par personne par nuit
  
  // Exemptions
  exemptions Json @default("{ \"minAge\": 18, \"maxNights\": null }")
  
  // Application
  startDate DateTime?
  endDate   DateTime?
  
  @@index([tenantId])
}

enum TaxCalculationType {
  FIXED_PER_PERSON_PER_NIGHT
  PERCENTAGE_OF_PRICE
  HYBRID
}

// ==================== AVIS ====================

model Review {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  propertyId String
  property   Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)

  bookingId String  @unique
  booking   Booking @relation(fields: [bookingId], references: [id], onDelete: Cascade)

  // Notes
  overall      Int // 1-5
  cleanliness  Int?
  accuracy     Int?
  checkIn      Int?
  communication Int?
  location     Int?
  value        Int?

  // Commentaire
  comment      String? @db.Text
  privateReply String? @db.Text

  // Statut
  isPublished Boolean @default(true)
  isVerified  Boolean @default(false)

  @@index([propertyId])
  @@index([bookingId])
  @@index([overall])
}

// ==================== EMAILS ====================

model EmailTemplate {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Multi-tenancy
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  type      EmailType
  name      String
  subject   Json      // Multilingue
  content   Json      // Multilingue, HTML
  variables Json      // Variables disponibles
  isActive  Boolean   @default(true)

  @@unique([tenantId, type])
  @@index([tenantId])
  @@index([type])
}

enum EmailType {
  BOOKING_CONFIRMATION
  BOOKING_REMINDER
  BOOKING_CANCELLATION
  PAYMENT_CONFIRMATION
  PAYMENT_FAILED
  REVIEW_REQUEST
  WELCOME_OWNER
  WELCOME_GUEST
}

model EmailLog {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  
  // Multi-tenancy
  tenantId String
  
  recipient String
  subject   String
  template  String
  status    String   // sent, failed, bounced
  
  metadata  Json?
  sentAt    DateTime?
  error     String?
  
  @@index([tenantId])
  @@index([status])
  @@index([createdAt])
}

// ==================== INTÉGRATIONS ====================

model Integration {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Multi-tenancy
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  type         IntegrationType
  isActive     Boolean         @default(true)
  credentials  Json            // Chiffré
  settings     Json
  lastSyncAt   DateTime?
  syncStatus   String?

  @@unique([tenantId, type])
  @@index([tenantId])
  @@index([type])
}

enum IntegrationType {
  AIRBNB
  BOOKING_COM
  GOOGLE_CALENDAR
  ICAL
}

// ==================== AUDIT ====================

model AuditLog {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())

  // Multi-tenancy
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  userId String?
  user   User?   @relation(fields: [userId], references: [id], onDelete: SetNull)

  action   String
  entity   String
  entityId String?
  details  Json?
  ip       String?
  userAgent String?

  @@index([tenantId])
  @@index([userId])
  @@index([entity, entityId])
  @@index([createdAt])
}

// ==================== RECHERCHE IA ====================

model SearchQuery {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())

  originalQuery    String   @db.Text
  parsedIntent     Json     // Intention extraite par IA
  embedding        Float[] @default([]) // Vector de la requête
  
  // Résultats
  returnedIds      String[] // IDs des propriétés retournées
  clickedId        String?  // ID cliqué
  bookedId         String?  // ID réservé
  
  // Métriques
  processingTimeMs Int
  resultCount      Int
  
  @@index([createdAt])
}

// ==================== CODES PROMOTIONNELS ====================

model PromoCode {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Multi-tenancy
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  // Code unique
  code         String   @unique
  description  String?
  
  // Type de réduction
  discountType DiscountType // PERCENTAGE ou FIXED_AMOUNT
  discountValue Float       // Pourcentage (0-100) ou montant fixe
  
  // Conditions
  minAmount    Float?       // Montant minimum de réservation
  minNights    Int?         // Nombre minimum de nuits
  propertyIds  String[]     // Propriétés éligibles (vide = toutes)
  
  // Période de validité
  validFrom    DateTime
  validUntil   DateTime
  
  // Limites d'utilisation
  maxUses      Int?         // Nombre max d'utilisations (null = illimité)
  maxUsesPerUser Int?       // Max par utilisateur
  currentUses  Int          @default(0)
  
  // Statut
  isActive     Boolean      @default(true)
  
  // Relations
  bookings     Booking[]
  
  @@index([code])
  @@index([tenantId])
  @@index([validFrom, validUntil])
}

enum DiscountType {
  PERCENTAGE
  FIXED_AMOUNT
}

// ==================== PHASE 4 - IA & INNOVATIONS ====================

// Conversations IA
model AIConversation {
  id            String   @id @default(cuid())
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  userId        String?
  sessionId     String   // Pour les utilisateurs non connectés
  
  messages      Json[]   // Historique de la conversation
  context       Json     // Contexte et préférences extraites
  
  // Résultats
  searchResults Json[]   // Propriétés suggérées
  bookingId     String?  // Si conversion en réservation
  
  @@index([userId])
  @@index([sessionId])
  @@index([createdAt])
}

// Prédictions ML
model MLPrediction {
  id            String   @id @default(cuid())
  createdAt     DateTime @default(now())
  
  propertyId    String
  property      Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  
  type          PredictionType
  targetDate    DateTime
  prediction    Json     // Valeurs prédites
  confidence    Float    // Score de confiance 0-1
  actualValue   Float?   // Valeur réelle (pour comparaison)
  
  @@index([propertyId])
  @@index([type])
  @@index([targetDate])
}

enum PredictionType {
  PRICE_OPTIMAL
  DEMAND_FORECAST
  OCCUPANCY_RATE
  REVENUE_PROJECTION
}

// Embeddings pour recherche sémantique
model PropertyEmbedding {
  id            String   @id @default(cuid())
  propertyId    String   @unique
  property      Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  
  embedding     Float[]  // Vecteur de dimension 1536 (OpenAI)
  model         String   // Modèle utilisé (ex: text-embedding-3-small)
  updatedAt     DateTime @default(now())
  
  @@index([propertyId])
}

// Sessions mobiles
model MobileSession {
  id            String   @id @default(cuid())
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  userId        String
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  deviceId      String
  platform      String   // ios, android
  appVersion    String
  osVersion     String
  
  pushToken     String?  @unique
  lastSync      DateTime @default(now())
  isActive      Boolean  @default(true)
  
  @@index([userId])
  @@index([deviceId])
}

// Dispositifs IoT
model SmartDevice {
  id            String   @id @default(cuid())
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  propertyId    String
  property      Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  
  type          DeviceType
  manufacturer  String
  model         String
  serialNumber  String?
  
  // Connexion
  apiEndpoint   String?
  credentials   Json?    // Chiffré
  
  // État
  status        Json     // État actuel du dispositif
  lastSeen      DateTime
  isOnline      Boolean  @default(false)
  
  @@index([propertyId])
  @@index([type])
}

enum DeviceType {
  SMART_LOCK
  THERMOSTAT
  CAMERA
  SMOKE_DETECTOR
  NOISE_MONITOR
  ENERGY_METER
}

// Transactions blockchain
model BlockchainTransaction {
  id            String   @id @default(cuid())
  createdAt     DateTime @default(now())
  
  bookingId     String
  booking       Booking  @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  
  type          BlockchainTxType
  network       String   // ethereum, polygon, etc.
  txHash        String   @unique
  
  // Détails
  fromAddress   String
  toAddress     String
  amount        String   // En wei
  gasUsed       String?
  
  // Statut
  status        String   // pending, confirmed, failed
  confirmations Int      @default(0)
  confirmedAt   DateTime?
  
  @@index([bookingId])
  @@index([txHash])
  @@index([status])
}

enum BlockchainTxType {
  DEPOSIT_LOCK
  DEPOSIT_RELEASE
  PAYMENT
  REFUND
  SMART_CONTRACT_CALL
}

// Programme de fidélité
model LoyaltyProgram {
  id            String   @id @default(cuid())
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  userId        String   @unique
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  points        Int      @default(0)
  tier          LoyaltyTier @default(BRONZE)
  
  // Statistiques
  totalBookings Int      @default(0)
  totalSpent    Float    @default(0)
  
  // NFTs
  nftTokenIds   String[] // IDs des NFTs possédés
  
  @@index([userId])
  @@index([tier])
}

enum LoyaltyTier {
  BRONZE
  SILVER
  GOLD
  PLATINUM
  DIAMOND
}

// Analytics avancés
model PropertyAnalytics {
  id            String   @id @default(cuid())
  date          DateTime @db.Date
  
  propertyId    String
  property      Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  
  // Métriques
  views         Int      @default(0)
  searches      Int      @default(0)
  bookings      Int      @default(0)
  revenue       Float    @default(0)
  
  // Sources
  sourceData    Json     // Détail par source (direct, search, social...)
  
  // Comparaisons
  marketAverage Json?    // Données moyennes du marché
  
  @@unique([propertyId, date])
  @@index([propertyId])
  @@index([date])
}